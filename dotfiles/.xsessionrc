#!/bin/bash

# X11-only setup
if [ -n "$DISPLAY" ]; then
  setxkbmap \
    -rules evdev \
    -model pc105 \
    -layout hu

  xset b off

  if [ -f "$HOME/.Xdefaults" ]; then
    xrdb "$HOME/.Xdefaults"
  fi
fi

for p in $(pidof trayer nm-applet copyq); do
  kill $p
done

# X11-only autostart
if [ -n "$DISPLAY" ]; then
  type "light-locker" >/dev/null 2>&1 && light-locker &

  type "trayer" >/dev/null 2>&1 && trayer --widthtype request --align right \
    --height 32 --transparent true --alpha 0 --tint 0x0B0B0B &

  type "nm-applet" >/dev/null 2>&1 && nm-applet &

  type "pasystray" >/dev/null 2>&1 && pidof pasystray || pasystray &
fi

if type "ssh-agent" >/dev/null 2>&1; then
  if [ -z "$SSH_AUTH_SOCK" ]; then
    eval "$(ssh-agent)"
    if type "ssh-askpass" >/dev/null 2>&1; then
      export SSH_ASKPASS=ssh-askpass
      ssh-add </dev/null
    fi
  fi
fi

type "copyq" >/dev/null 2>&1 && copyq &

type "v4l2-ctl" >/dev/null 2>&1 && {
  v4l2-ctl \
    --set-ctrl=brightness=160 \
    --set-ctrl=contrast=45 \
    --set-ctrl=saturation=45 \
    --set-ctrl=hue=7 \
    --set-ctrl=white_balance_temperature_auto=1 \
    --set-ctrl=gamma=110 \
    --set-ctrl=power_line_frequency=1 \
    --set-ctrl=sharpness=1 \
    --set-ctrl=backlight_compensation=1 \
    --set-ctrl=exposure_auto=3 \
    --set-ctrl=exposure_auto_priority=1
}

# X11-only: monitor for session unlock to re-apply display layout
if [ -n "$DISPLAY" ]; then
  gdbus monitor --system --dest org.freedesktop.login1 | grep org.freedesktop.login1.Session.Unlock |
    while read -r line; do
      autorandr --change
    done &

  type "autorandr" >/dev/null 2>&1 && autorandr --change
fi
